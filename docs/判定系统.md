# 判定系统

## 一、按键判定范围
> 注：所有的判定均会四舍五入去做比较：
> 也就是如果打击时间是 16.4，则会以 16.0 比较，为 300g
> 如果是 16.5，则会以 17.0 比较，为 300

### 1. 普通音符的判定
> 取决于打击时间，直接根据打击时间判定

| 判定      | 最大偏差 (±ms)         |
|---------|--------------------|
| 300g    | 16.0               |
| 300     | 64.0 - 3 * od      |
| 200     | 97.0 - 3 * od      |
| 100     | 127.0 - 3 * od     |
| 50      | 151.0 - 3 * od     |
| MISS    | 188.0 - 3 * od     |

![note-judge1.png](img%2Fnote-judge1.png)

> 注：点击到过早的 MISS 区间，则不进行判定，点击到过晚的 MISS 区间之后，则直接判定为 MISS。

### 2.长按音符判定
> 长按音符
> 取决于音符头按下按键、音符尾松开按键的准确度，长按音符整体给出一个判定。根据如下表格，其中整体打击误差等于音符头打击误差+音符尾打击误差（均为正值）：
> 注：若在打击过程中（没有到尾判区间）松开按键，则会等待下一次判定，并且不计分，且 Combo 清零

| 判定   | 音符头打击误差 (ms)          | 整体打击误差 (ms)                   |
|------|-----------------------|-------------------------------|
| 300g | 16.0 * 1.2            | 32.0 * 2.4                    |
| 300  | (64.0 - 3 * od) * 1.1 | (128.0 - 3 * od) * 2.2        |
| 200  | (97.0 - 3 * od)       | (194.0 - 3 * od) * 2.2        |
| 100  | (127.0 - 3 * od)      | (254.0 - 3 * od) * 2.2        |
| 50   | NONE                  | 不是 MISS 的其他情况                 |
| MISS | NONE                  | 从音符尾的较早 MEH 区间至较晚 OK 区间没有按住按键 |

通过尾判判定是否 MISS 的逻辑
![release-miss-judge.png](img%2Frelease-miss-judge.png)


## 二、打击误差
> 打击误差是指打击时间与音符时间的差值，正值表示打击时间晚于音符时间，负值表示打击时间早于音符时间。

计算方式：
> 打击误差 = 打击时间 - 音符时间

## 三、局内判定计算

### 1. 时间系统
* 游戏开始时：记录开始时间 StartTime
* 游戏此刻的时间为：CurrentTime
* 局内此刻时间为：CurrentTiming = CurrentTime - StartTime
* 每次打击（或松开）时：记录打击（或松开）时间 HitTime(ReleaseTime)
* 局内打击时间: HitTiming = HitTime - StartTime (ReleaseTiming = ReleaseTime - StartTime)
* 当前音符的判定时间为：NoteOffset
* 打击偏差：Deviation = HitTiming - NoteOffset

### 1. 普通按键
> 普通按键的判定计算方式为：
> 判定 = 判定范围 - 打击误差

> 没有打击的判定计算：
当 CurrentTiming - NoteOffset > 151.0 - 3 * od 时，判定为 MISS。


打击判定计算
```javascript
function calculateHitJudgement (noteOffset, hitTiming, od) {
  const deviation = hitTiming - noteOffset;
  let judgement;

  // 点击早于最早的 BAD 区间则不进行判定
  if (deviation < 151.0 - 3 * od) {
    return 'NONE'
  }

  if (deviation > 151.0 - 3 * od) {
    return 'MISS'; // Too late
  }

  if (Math.abs(deviation) <= 16.0) {
    return '300g';
  } else if (Math.abs(deviation) <= 64.0 - 3 * od) {
    return '300';
  } else if (Math.abs(deviation) <= 97.0 - 3 * od) {
    return '200';
  } else if (Math.abs(deviation) <= 127.0 - 3 * od) {
    return '100';
  } else if (Math.abs(deviation) <= 151.0 - 3 * od) {
    return '50';
  } else {
    return 'NONE'
  }
}
```

### 2. 长条按键
> 长条按键的判定计算方式：
1. 如果已经按下，但在较早的 50 区间之前松手，则不生成判定，且 Combo 清零并灰条，hitTiming 和 releaseTiming 重置， 等待下一轮判定，否则进入正常判定
2. 如果按下，但过了最晚的 meh 区间（进入了miss区间）还没有松手，则拿着最晚的 MEH 区间作为尾判去生成判定。
3. 判断是否 MISS
4. 判断 300g,300,200,100 的判定
5. 默认判定为 50

## 二、打击偏差
